<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Wajib Pajak Daerah - SIDRAP</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- shp.js -->
    <script src="https://unpkg.com/shpjs@4.0.4/dist/shp.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Map container styles */
        #wpMap {
            width: 100%;
            height: 100%;
            min-height: 400px;
            z-index: 1;
            border-radius: 0.75rem;
        }
        
        #wpMapContainer {
            position: relative;
            min-height: 400px;
        }
        
        /* Leaflet container fix */
        .leaflet-container {
            width: 100% !important;
            height: 100% !important;
            border-radius: 0.75rem;
            font-family: 'Poppins', sans-serif;
        }
        
        /* Popup styles */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            padding: 0;
        }
        
        .leaflet-popup-content {
            margin: 0;
            padding: 0;
        }
        
        .leaflet-popup-tip {
            background: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }
        
        /* Zoom control */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
            border-radius: 8px !important;
            overflow: hidden;
        }
        
        .leaflet-control-zoom a {
            width: 36px !important;
            height: 36px !important;
            line-height: 36px !important;
            border: none !important;
            background: white !important;
            color: #374151 !important;
            transition: all 0.2s;
        }
        
        .leaflet-control-zoom a:hover {
            background: #f3f4f6 !important;
            color: #3b82f6 !important;
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tax-card {
            transition: all 0.3s ease;
        }
        
        .tax-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Sidebar */
        .sidebar-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-link.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid white;
        }
        
        /* Map button styles */
        .map-btn {
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            outline: none;
        }
        
        .map-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Status indicators */
        .status-success {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Loading animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Modal backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Table hover */
        tbody tr:hover {
            background-color: #f9fafb;
        }
        
        /* Input field focus */
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }
        
        /* Progress bar */
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        /* Checkbox styling */
        .tax-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 via-blue-800 to-blue-600">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-6">
                <div class="flex justify-center mb-4">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/Coat_of_arms_of_Sidrap_Regency.svg/1200px-Coat_of_arms_of_Sidrap_Regency.svg.png" 
                         alt="Logo SIDRAP" 
                         class="w-24 h-24 object-contain"
                         onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center text-white text-4xl font-bold\'>S</div>'">
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Database Wajib Pajak</h1>
                <p class="text-gray-500">Kabupaten Sidenreng Rappang</p>
                <p class="text-xs text-gray-400 mt-1">Berdasarkan UU No. 1 Tahun 2022 & PP 35 Tahun 2024</p>
            </div>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="loginUsername" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200">
                    <i class="fas fa-sign-in-alt mr-2"></i>Masuk
                </button>
            </form>
            <div class="mt-4 text-center text-sm text-gray-500">
                <p>Demo: admin / admin123</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <div class="flex h-screen overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-64 bg-gradient-to-b from-blue-900 to-blue-800 text-white flex flex-col">
                <div class="p-4 border-b border-blue-700">
                    <div class="flex items-center gap-3">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/Coat_of_arms_of_Sidrap_Regency.svg/1200px-Coat_of_arms_of_Sidrap_Regency.svg.png" 
                             alt="Logo" 
                             class="w-12 h-12 object-contain"
                             onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white text-xl font-bold\'>S</div>'">
                        <div>
                            <h1 class="font-bold text-sm">Database Wajib Pajak</h1>
                            <p class="text-xs text-blue-300">Kab. SIDRAP</p>
                        </div>
                    </div>
                </div>
                <nav class="flex-1 py-4 overflow-y-auto">
                    <a href="#" onclick="showPage('dashboard')" class="sidebar-link active flex items-center gap-3 px-4 py-3" id="nav-dashboard">
                        <i class="fas fa-tachometer-alt w-5"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" onclick="showPage('input-wp')" class="sidebar-link flex items-center gap-3 px-4 py-3" id="nav-input-wp">
                        <i class="fas fa-user-plus w-5"></i>
                        <span>Input Wajib Pajak</span>
                    </a>
                    <a href="#" onclick="showPage('data-wp')" class="sidebar-link flex items-center gap-3 px-4 py-3" id="nav-data-wp">
                        <i class="fas fa-users w-5"></i>
                        <span>Data Wajib Pajak</span>
                    </a>
                    <a href="#" onclick="showPage('peta-blok')" class="sidebar-link flex items-center gap-3 px-4 py-3" id="nav-peta-blok">
                        <i class="fas fa-map w-5"></i>
                        <span>Peta Blok</span>
                    </a>
                    <a href="#" onclick="showPage('users')" class="sidebar-link flex items-center gap-3 px-4 py-3" id="nav-users">
                        <i class="fas fa-user-cog w-5"></i>
                        <span>Kelola User</span>
                    </a>
                    <a href="#" onclick="showPage('laporan')" class="sidebar-link flex items-center gap-3 px-4 py-3" id="nav-laporan">
                        <i class="fas fa-chart-bar w-5"></i>
                        <span>Laporan</span>
                    </a>
                    <a href="#" onclick="showPage('realisasi')" class="sidebar-link flex items-center gap-3 px-4 py-3" id="nav-realisasi">
                        <i class="fas fa-coins w-5"></i>
                        <span>Realisasi Pajak</span>
                    </a>
                    <a href="#" onclick="showPage('database-online')" class="sidebar-link flex items-center gap-3 px-4 py-3" id="nav-database-online">
                        <i class="fas fa-cloud w-5"></i>
                        <span>Database Online</span>
                    </a>
                </nav>
                <div class="p-4 border-t border-blue-700">
                    <div class="flex items-center gap-3 mb-3 px-4">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium" id="currentUserName">Admin</p>
                            <p class="text-xs text-blue-300" id="currentUserRole">Administrator</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-auto">
                <!-- Dashboard Page -->
                <div id="page-dashboard" class="p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
                        <p class="text-gray-500">Overview Database Wajib Pajak Daerah</p>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-md p-6 tax-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Wajib Pajak</p>
                                    <p class="text-3xl font-bold text-gray-800" id="totalWp">0</p>
                                </div>
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-users text-blue-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-6 tax-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Pajak Aktif</p>
                                    <p class="text-3xl font-bold text-green-600" id="pajakAktif">0</p>
                                </div>
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-6 tax-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">Total Pendapatan</p>
                                    <p class="text-3xl font-bold text-yellow-600" id="totalPendapatan">Rp 0</p>
                                </div>
                                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-money-bill-wave text-yellow-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-6 tax-card">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm">User Aktif</p>
                                    <p class="text-3xl font-bold text-purple-600" id="userAktif">0</p>
                                </div>
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-friends text-purple-600 text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Statistik Jenis Pajak</h3>
                            <canvas id="taxTypeChart" height="250"></canvas>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Pajak Terbaru</h3>
                            <div id="recentTaxList" class="space-y-3 max-h-64 overflow-y-auto">
                                <p class="text-gray-500 text-center py-4">Belum ada data</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Realisasi Summary -->
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Ringkasan Realisasi Pajak</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-sm text-blue-600">Target Tahun <span id="dashTargetYear">2025</span></p>
                                <p class="text-2xl font-bold text-blue-800" id="dashTarget">Rp 0</p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4">
                                <p class="text-sm text-green-600">Realisasi</p>
                                <p class="text-2xl font-bold text-green-800" id="dashRealisasi">Rp 0</p>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <p class="text-sm text-purple-600">Persentase</p>
                                <p class="text-2xl font-bold text-purple-800" id="dashPersen">0%</p>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-4">
                                <p class="text-sm text-yellow-600">Selisih</p>
                                <p class="text-2xl font-bold text-yellow-800" id="dashSelisih">Rp 0</p>
                            </div>
                        </div>
                        <div class="h-4 bg-gray-200 rounded-full overflow-hidden">
                            <div id="dashProgressBar" class="h-full bg-gradient-to-r from-blue-500 to-green-500 progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Input Wajib Pajak Page -->
                <div id="page-input-wp" class="hidden p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Input Wajib Pajak</h2>
                        <p class="text-gray-500">Masukkan data wajib pajak sesuai UU No. 1 Tahun 2022 & PP 35 Tahun 2024</p>
                    </div>

                    <form id="wpForm" class="space-y-6">
                        <!-- Data Umum Wajib Pajak -->
                        <div class="bg-white rounded-xl shadow-md p-6 fade-in">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-user mr-2 text-blue-600"></i>
                                Data Umum Wajib Pajak
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NIK (Warga Negara Indonesia) *</label>
                                    <input type="text" name="nik" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Masukkan NIK" required>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NPWPD (Bagi Wajib Pajak Daerah)</label>
                                    <input type="text" name="npwp" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Masukkan NPWPD (opsional)">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap Wajib Pajak *</label>
                                    <input type="text" name="nama" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nama sesuai KTP" required>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Usaha</label>
                                    <input type="text" name="namaUsaha" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nama usaha (opsional)">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" name="email" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="email@contoh.com">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Telepon/HP *</label>
                                    <input type="tel" name="telepon" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="08xxxxxxxxxx" required>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kelamin</label>
                                    <select name="jenisKelamin" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="L">Laki-laki</option>
                                        <option value="P">Perempuan</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status Wajib Pajak *</label>
                                    <select name="status" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="perorangan">Perorangan</option>
                                        <option value="badan">Badan Usaha</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status Keaktifan *</label>
                                    <select name="statusKeaktifan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="Aktif">Aktif</option>
                                        <option value="Tidak Aktif">Tidak Aktif</option>
                                        <option value="Dalam Pengawasan">Dalam Pengawasan</option>
                                        <option value="Dihentikan Sementara">Dihentikan Sementara</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status Kepatuhan *</label>
                                    <select name="kepatuhan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="Patuh">Patuh</option>
                                        <option value="Tidak Patuh">Tidak Patuh</option>
                                        <option value="Dalam Proses Verifikasi">Dalam Proses Verifikasi</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Alamat Domisili *</label>
                                    <textarea name="alamat" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" rows="2" placeholder="Alamat lengkap sesuai KTP" required></textarea>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kecamatan *</label>
                                    <select name="kecamatan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" required>
                                        <option value="">Pilih Kecamatan</option>
                                        <option value="Sidenreng">Sidenreng</option>
                                        <option value="Baranti">Baranti</option>
                                        <option value="Panca Rijang">Panca Rijang</option>
                                        <option value="Citta">Citta</option>
                                        <option value="Watang Sidenreng">Watang Sidenreng</option>
                                        <option value="Dua Pitue">Dua Pitue</option>
                                        <option value="Kulo">Kulo</option>
                                        <option value="Maritengngae">Maritengngae</option>
                                        <option value="Tellu Limpoe">Tellu Limpoe</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kelurahan/Desa *</label>
                                    <input type="text" name="kelurahan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Masukkan nama kelurahan/desa" required>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kode Pos</label>
                                    <input type="text" name="kodePos" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="xxxxx">
                                </div>
                            </div>
                        </div>

                        <!-- Lokasi & Titik Koordinat -->
                        <div class="bg-white rounded-xl shadow-md p-6 fade-in">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-map-marker-alt mr-2 text-red-600"></i>
                                Lokasi & Titik Koordinat
                            </h3>
                            <p class="text-sm text-gray-500 mb-4">Tentukan titik koordinat lokasi wajib pajak dengan mengklik pada peta</p>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Map Container -->
                                <div>
                                    <div class="mb-3 flex items-center justify-between">
                                        <div class="flex gap-2">
                                            <button type="button" id="btnStreetView" onclick="switchMapView('street')" class="map-btn px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium flex items-center gap-2">
                                                <i class="fas fa-road"></i>
                                                <span>Peta Jalan</span>
                                            </button>
                                            <button type="button" id="btnSatelliteView" onclick="switchMapView('satellite')" class="map-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium flex items-center gap-2">
                                                <i class="fas fa-satellite-dish"></i>
                                                <span>Satelit</span>
                                            </button>
                                        </div>
                                        <span class="text-xs text-gray-500 flex items-center">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Klik peta untuk menentukan lokasi
                                        </span>
                                    </div>
                                    
                                    <div id="wpMapContainer" class="relative w-full h-96 rounded-xl border-2 border-gray-200 bg-gray-100 overflow-hidden" style="min-height: 400px;">
                                        <div id="wpMap" class="absolute inset-0 w-full h-full" style="z-index: 1;"></div>
                                        
                                        <!-- Loading overlay -->
                                        <div id="mapLoading" class="absolute inset-0 bg-gray-100 flex flex-col items-center justify-center z-10">
                                            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-3"></i>
                                            <p class="text-gray-600 text-sm">Memuat peta...</p>
                                            <p class="text-gray-400 text-xs mt-1">Silakan tunggu</p>
                                        </div>
                                        
                                        <!-- Error overlay -->
                                        <div id="mapError" class="absolute inset-0 bg-red-50 hidden flex flex-col items-center justify-center z-10">
                                            <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-3"></i>
                                            <p class="text-red-600 text-sm">Gagal memuat peta</p>
                                            <button onclick="initializeWPMaps()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded-lg text-sm">
                                                Coba Lagi
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3 flex flex-wrap gap-4 text-xs text-gray-500">
                                        <span class="flex items-center">
                                            <i class="fas fa-mouse-pointer mr-1 text-blue-500"></i>
                                            Klik untuk menentukan titik
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fas fa-arrows-alt mr-1 text-green-500"></i>
                                            Geser untuk pan
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fas fa-search-plus mr-1 text-purple-500"></i>
                                            Scroll untuk zoom
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Coordinate Inputs -->
                                <div class="space-y-4">
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <h4 class="font-medium text-gray-700 mb-3 flex items-center">
                                            <i class="fas fa-crosshairs mr-2 text-blue-600"></i>
                                            Koordinat Lokasi
                                        </h4>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            <div class="input-group">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    <i class="fas fa-map-marker-alt mr-1 text-red-500"></i>
                                                    Latitude
                                                </label>
                                                <input type="text" name="latitude" id="latitude" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-white" readonly placeholder="Klik peta untuk mendapatkan">
                                            </div>
                                            
                                            <div class="input-group">
                                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                                    <i class="fas fa-map-marker-alt mr-1 text-red-500"></i>
                                                    Longitude
                                                </label>
                                                <input type="text" name="longitude" id="longitude" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-white" readonly placeholder="Klik peta untuk mendapatkan">
                                            </div>
                                        </div>
                                        
                                        <div class="input-group">
                                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                                <i class="fas fa-map-pin mr-1 text-blue-500"></i>
                                                Alamat dari Koordinat
                                            </label>
                                            <textarea id="addressFromCoord" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg bg-gray-100" rows="3" readonly placeholder="Klik peta untuk mendapatkan alamat otomatis"></textarea>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Buttons -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        <button type="button" onclick="getCurrentLocation()" class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition-colors">
                                            <i class="fas fa-location-arrow"></i>
                                            <span>Lokasi Saya (GPS)</span>
                                        </button>
                                        
                                        <button type="button" onclick="clearMapLocation()" class="flex items-center justify-center gap-2 bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg transition-colors">
                                            <i class="fas fa-trash-alt"></i>
                                            <span>Hapus Lokasi</span>
                                        </button>
                                    </div>
                                    
                                    <!-- Current Location Status -->
                                    <div id="locationStatus" class="hidden">
                                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                            <div class="flex items-center">
                                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                                <span class="text-sm text-green-700 font-medium">Lokasi Telah Ditentukan</span>
                                            </div>
                                            <p id="locationStatusDetails" class="text-xs text-green-600 mt-1"></p>
                                        </div>
                                    </div>
                                    
                                    <!-- Map Info -->
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <p class="text-sm text-blue-700 font-medium mb-2">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Petunjuk Penggunaan
                                        </p>
                                        <ul class="text-xs text-blue-600 space-y-1 ml-4 list-disc">
                                            <li>Klik tombol <strong>Peta Jalan</strong> atau <strong>Satelit</strong> untuk mengubah tampilan</li>
                                            <li>Klik langsung pada peta untuk menentukan titik koordinat wajib pajak</li>
                                            <li>Gunakan <strong>Lokasi Saya</strong> untuk mendapatkan posisi GPS otomatis</li>
                                            <li>Drag peta untuk berpindah area</li>
                                            <li>Scroll mouse untuk zoom in/out</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Jenis Pajak -->
                        <div class="bg-white rounded-xl shadow-md p-6 fade-in">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-file-invoice-dollar mr-2 text-green-600"></i>
                                Jenis Pajak (Berdasarkan UU No. 1/2022 & PP 35/2024)
                            </h3>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-4">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="reklame" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('reklame')">
                                    <span class="text-sm">Pajak Reklame</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="airtanah" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('airtanah')">
                                    <span class="text-sm">Pajak Air Tanah</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="walet" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('walet')">
                                    <span class="text-sm">Pajak Walet</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="mineral" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('mineral')">
                                    <span class="text-sm">Mineral</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="pbbp2" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('pbbp2')">
                                    <span class="text-sm">PBB-P2</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="bphtb" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('bphtb')">
                                    <span class="text-sm">BPHTB</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="pbjt_makanan" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('pbjt_makanan')">
                                    <span class="text-sm">PBJT M&M</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="pbjt_listrik" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('pbjt_listrik')">
                                    <span class="text-sm">PBJT Listrik</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="pbjt_perhotelan" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('pbjt_perhotelan')">
                                    <span class="text-sm">PBJT Hotel</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="pbjt_parkir" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('pbjt_parkir')">
                                    <span class="text-sm">PBJT Parkir</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="pbjt_hiburan" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('pbjt_hiburan')">
                                    <span class="text-sm">PBJT Hiburan</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="opsen_pkb" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('opsen_pkb')">
                                    <span class="text-sm">Opsen PKB</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" name="jenisPajak" value="opsen_bbnkb" class="tax-checkbox w-4 h-4 text-blue-600 rounded" onchange="showTaxFields('opsen_bbnkb')">
                                    <span class="text-sm">Opsen BBNKB</span>
                                </label>
                            </div>
                        </div>

                        <!-- Fields Pajak Reklame -->
                        <div id="fields-reklame" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data Pajak Reklame (UU 1/2022)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Reklame *</label>
                                    <select name="reklame_jenis" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih Jenis</option>
                                        <option value="papan">Papan/Reklame Papan</option>
                                        <option value="vertikal">Reklame Vertikal</option>
                                        <option value="megatron">LED/Megatron</option>
                                        <option value="baliho">Baliho</option>
                                        <option value="neon">Neon Box</option>
                                        <option value="spanduk">Spanduk</option>
                                        <option value="banner">Banner</option>
                                        <option value="jersey">Reklame Jersey</option>
                                        <option value="liflet">Liflet</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ukuran Panjang (m) *</label>
                                    <input type="number" step="0.01" name="reklame_panjang" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Ukuran Lebar (m) *</label>
                                    <input type="number" step="0.01" name="reklame_lebar" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Unit *</label>
                                    <input type="number" name="reklame_jumlah_unit" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Sisi *</label>
                                    <input type="number" name="reklame_jumlah_sisi" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Masa Tayang (hari) *</label>
                                    <input type="number" name="reklame_masa_tayang" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Brand/Merek *</label>
                                    <input type="text" name="reklame_brand" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nama brand/reklame">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Izin/IPAT (Opsional)</label>
                                    <input type="text" name="reklame_no_izin" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nomor izin">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Penggunaan *</label>
                                    <select name="reklame_jenis_penggunaan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="komersial">Komersial</option>
                                        <option value="non_komersial">Non Komersial</option>
                                        <option value="pemerintah">Pemerintah</option>
                                        <option value="social">Sosial</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Fields Pajak Air Tanah -->
                        <div id="fields-airtanah" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data Pajak Air Tanah (UU 1/2022)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Izin/IPAT (Opsional)</label>
                                    <input type="text" name="airtanah_no_izin" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nomor izin">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Penggunaan *</label>
                                    <select name="airtanah_jenis_penggunaan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="industri">Industri</option>
                                        <option value="komersial">Komersial</option>
                                        <option value="rumah_tangga">Rumah Tangga</option>
                                        <option value="pertanian">Pertanian</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Sumur Bor *</label>
                                    <input type="number" name="airtanah_jumlah_sumur" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Sumur Resapan *</label>
                                    <input type="number" name="airtanah_jumlah_resapan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kedalaman Sumur (meter) *</label>
                                    <input type="number" step="0.01" name="airtanah_kedalaman" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pemakaian Volume Air (m/hari) *</label>
                                    <input type="number" step="0.01" name="airtanah_volume_harian" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pemakaian Volume Air (m/bulan) *</label>
                                    <input type="number" step="0.01" name="airtanah_volume_bulanan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                            </div>
                        </div>

                        <!-- Fields Pajak Walet -->
                        <div id="fields-walet" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data Pajak Sarang Burung Walet (UU 1/2022)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Izin/IUPTW (Opsional)</label>
                                    <input type="text" name="walet_no_izin" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nomor izin">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Gedung Walet *</label>
                                    <input type="number" name="walet_jumlah_gedung" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Luas Gedung (m) *</label>
                                    <input type="number" step="0.01" name="walet_luas" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Perkiraan Produksi/tahun (kg) *</label>
                                    <input type="number" step="0.01" name="walet_produksi" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Klasifikasi Lokasi *</label>
                                    <select name="walet_klasifikasi" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="perkotaan">Perkotaan</option>
                                        <option value="pedesaan">Pedesaan</option>
                                        <option value="pantai">Pantai</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Fields Pajak Mineral -->
                        <div id="fields-mineral" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data Pajak Mineral Bukan Logam & Batuan (UU 1/2022)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. IUP/IUPK (Opsional)</label>
                                    <input type="text" name="mineral_no_izin" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nomor izin">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Mineral *</label>
                                    <select name="mineral_jenis" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih Jenis</option>
                                        <option value="pasir">Pasir</option>
                                        <option value="batu_pecah">Batu Pecah</option>
                                        <option value="kerikil">Kerikil</option>
                                        <option value="tanah_liat">Tanah Liat</option>
                                        <option value="kapur">Kapur</option>
                                        <option value="granit">Granit</option>
                                        <option value="marmer">Marmer</option>
                                        <option value="andesit">Andesit</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Volume Produksi (m/tahun) *</label>
                                    <input type="number" step="0.01" name="mineral_volume" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Luas Area Penambangan (Ha) *</label>
                                    <input type="number" step="0.01" name="mineral_luas" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Metode Penambangan *</label>
                                    <select name="mineral_metode" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="terbuka">Terbuka</option>
                                        <option value="terbatas">Terbatas/Tertutup</option>
                                        <option value="quarry">Quarry</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Fields PBB-P2 -->
                        <div id="fields-pbbp2" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data Pajak Bumi dan Bangunan Perdesaan dan Perkotaan (PBB-P2)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NOP *</label>
                                    <input type="text" name="pbb_nop" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="18.04.XXX.XXX.XXX-XX">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Luas Tanah (m) *</label>
                                    <input type="number" step="0.01" name="pbb_luas_tanah" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Luas Bangunan (m) *</label>
                                    <input type="number" step="0.01" name="pbb_luas_bangunan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NJOP Tanah (Rp/m) *</label>
                                    <input type="number" name="pbb_njop_tanah" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NJOP Bangunan (Rp/m) *</label>
                                    <input type="number" name="pbb_njop_bangunan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Peruntukan *</label>
                                    <select name="pbb_peruntukan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="perkampungan">Perkampungan</option>
                                        <option value="perdagangan_dan_jasa">Perdagangan & Jasa</option>
                                        <option value="industri">Industri</option>
                                        <option value="kantor">Kantor</option>
                                        <option value="rumah_tangga">Rumah Tangga</option>
                                        <option value="tanah_kosong">Tanah Kosong</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Fields BPHTB -->
                        <div id="fields-bphtb" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data Bea Perolehan Hak atas Tanah dan Bangunan (BPHTB)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. SPPT BPHTB</label>
                                    <input type="text" name="bphtb_no_sppt" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nomor SPPT">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NOP</label>
                                    <input type="text" name="bphtb_nop" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="NOP">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Luas Tanah (m)</label>
                                    <input type="number" step="0.01" name="bphtb_luas_tanah" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Luas Bangunan (m)</label>
                                    <input type="number" step="0.01" name="bphtb_luas_bangunan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NJOP Tanah (Rp)</label>
                                    <input type="number" name="bphtb_njop_tanah" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">NJOP Bangunan (Rp)</label>
                                    <input type="number" name="bphtb_njop_bangunan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nilai Perolehan (Rp)</label>
                                    <input type="number" name="bphtb_nilai" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status Perolehan</label>
                                    <select name="bphtb_status" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="jual_beli">Jual Beli</option>
                                        <option value="hibah">Hibah</option>
                                        <option value="waris">Waris</option>
                                        <option value="tukar">Tukar Menukar</option>
                                        <option value="lelang">Lelang</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Fields PBJT Makanan & Minuman -->
                        <div id="fields-pbjt_makanan" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data PBJT Makanan & Minuman (PP 35/2024)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Izin Usaha</label>
                                    <input type="text" name="pbjt_makanan_no_izin" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nomor izin">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Usaha *</label>
                                    <input type="text" name="pbjt_makanan_nama_usaha" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nama usaha/restoran">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Omzet Estimasi (Rp/bulan) *</label>
                                    <input type="number" name="pbjt_makanan_omzet" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Makanan *</label>
                                    <select name="pbjt_makanan_jenis" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="restoran">Restoran</option>
                                        <option value="cafe">Cafe</option>
                                        <option value="warung">Warung</option>
                                        <option value="kios">Kios</option>
                                        <option value="kedai">Kedai</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Luas Area (m) *</label>
                                    <input type="number" step="0.01" name="pbjt_makanan_luas" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Kursi *</label>
                                    <input type="number" name="pbjt_makanan_kursi" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- Fields PBJT Listrik -->
                        <div id="fields-pbjt_listrik" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data PBJT Tenaga Listrik (PP 35/2024)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Kontrak/Daya PLN</label>
                                    <input type="text" name="pbjt_listrik_no_kontrak" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nomor kontrak">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Daya (VA) *</label>
                                    <input type="number" name="pbjt_listrik_daya" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pemakaian (kWh/bulan) *</label>
                                    <input type="number" step="0.01" name="pbjt_listrik_pemakaian" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Golongan Tarif *</label>
                                    <select name="pbjt_listrik_gol" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="sosial">Sosial</option>
                                        <option value="rumah_tangga">Rumah Tangga</option>
                                        <option value="bisnis">Bisnis</option>
                                        <option value="industri">Industri</option>
                                        <option value="pemerintah">Pemerintah</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Fields PBJT Perhotelan -->
                        <div id="fields-pbjt_perhotelan" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data PBJT Perhotelan (PP 35/2024)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Izin Hotel</label>
                                    <input type="text" name="pbjt_hotel_no_izin" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nomor izin">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Hotel *</label>
                                    <input type="text" name="pbjt_hotel_nama" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nama hotel">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Bintang *</label>
                                    <select name="pbjt_hotel_bintang" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="bintang_1">Bintang 1</option>
                                        <option value="bintang_2">Bintang 2</option>
                                        <option value="bintang_3">Bintang 3</option>
                                        <option value="bintang_4">Bintang 4</option>
                                        <option value="bintang_5">Bintang 5</option>
                                        <option value="non_bintang">Non Bintang</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Kamar *</label>
                                    <input type="number" name="pbjt_hotel_kamar" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tarif Rata-rata (Rp/malam) *</label>
                                    <input type="number" name="pbjt_hotel_tarif" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tingkat Penghuni (%) *</label>
                                    <input type="number" step="0.01" name="pbjt_hotel_occupancy" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0.00">
                                </div>
                            </div>
                        </div>

                        <!-- Fields PBJT Parkir -->
                        <div id="fields-pbjt_parkir" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data PBJT Parkir (PP 35/2024)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Izin Operasional</label>
                                    <input type="text" name="pbjt_parkir_no_izin" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nomor izin">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Tempat Parkir *</label>
                                    <input type="text" name="pbjt_parkir_nama" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nama tempat parkir">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Parkir *</label>
                                    <select name="pbjt_parkir_jenis" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="on_street">On Street</option>
                                        <option value="off_street">Off Street</option>
                                        <option value="basement">Basement</option>
                                        <option value="gedung">Gedung Parkir</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kapasitas (Kendaraan) *</label>
                                    <input type="number" name="pbjt_parkir_kapasitas" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pendapatan (Rp/bulan) *</label>
                                    <input type="number" name="pbjt_parkir_pendapatan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- Fields PBJT Hiburan -->
                        <div id="fields-pbjt_hiburan" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data PBJT Kesenian & Hiburan (PP 35/2024)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Izin</label>
                                    <input type="text" name="pbjt_hiburan_no_izin" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nomor izin">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Tempat *</label>
                                    <input type="text" name="pbjt_hiburan_nama" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Nama tempat hiburan">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Hiburan *</label>
                                    <select name="pbjt_hiburan_jenis" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="bioskop">Bioskop</option>
                                        <option value="karaoke">Karaoke</option>
                                        <option value="klub_malam">Klub Malam</option>
                                        <option value="game_center">Game Center</option>
                                        <option value="bowling">Bowling</option>
                                        <option value="kolam_renang">Kolam Renang</option>
                                        <option value="fitness">Fitness Center</option>
                                        <option value="spa">Spa</option>
                                        <option value="live_music">Live Music</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Kapasitas *</label>
                                    <input type="number" name="pbjt_hiburan_kapasitas" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Pendapatan (Rp/bulan) *</label>
                                    <input type="number" name="pbjt_hiburan_pendapatan" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- Fields Opsen PKB -->
                        <div id="fields-opsen_pkb" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data Opsen Pajak Kendaraan Bermotor (PKB)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Polisi Kendaraan *</label>
                                    <input type="text" name="opsen_pkb_nopol" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="DDxxxxXX">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Merk/Type Kendaraan *</label>
                                    <input type="text" name="opsen_pkb_merk" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Merk/type kendaraan">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Pembuatan *</label>
                                    <input type="number" name="opsen_pkb_tahun" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="20xx">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kendaraan *</label>
                                    <select name="opsen_pkb_jenis" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="roda_2">Roda 2</option>
                                        <option value="roda_3">Roda 3</option>
                                        <option value="roda_4">Roda 4</option>
                                        <option value="roda_6">Roda 6</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Bahan Bakar *</label>
                                    <select name="opsen_pkb_bahan_bakar" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="bensin">Bensin</option>
                                        <option value="solar">Solar</option>
                                        <option value="listrik">Listrik</option>
                                        <option value="gas">Gas</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">PKB Terutang (Rp) *</label>
                                    <input type="number" name="opsen_pkb_nilai" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                            </div>
                        </div>

                        <!-- Fields Opsen BBNKB -->
                        <div id="fields-opsen_bbnkb" class="hidden bg-white rounded-xl shadow-md p-6 fade-in">
                            <h4 class="text-md font-semibold text-gray-800 mb-4 border-b pb-2">Data Opsen Bea Balik Nama Kendaraan Bermotor (BBNKB)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">No. Polisi Kendaraan *</label>
                                    <input type="text" name="opsen_bbnkb_nopol" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="DDxxxxXX">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Merk/Type Kendaraan *</label>
                                    <input type="text" name="opsen_bbnkb_merk" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="Merk/type kendaraan">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tahun Pembuatan *</label>
                                    <input type="number" name="opsen_bbnkb_tahun" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="20xx">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Kendaraan *</label>
                                    <select name="opsen_bbnkb_jenis" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="roda_2">Roda 2</option>
                                        <option value="roda_3">Roda 3</option>
                                        <option value="roda_4">Roda 4</option>
                                        <option value="roda_6">Roda 6</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nilai Pembelian (Rp) *</label>
                                    <input type="number" name="opsen_bbnkb_nilai" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0">
                                </div>
                                <div class="input-group">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status Pengalihan *</label>
                                    <select name="opsen_bbnkb_status" class="input-field w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                                        <option value="">Pilih</option>
                                        <option value="jual_beli">Jual Beli</option>
                                        <option value="hibah">Hibah</option>
                                        <option value="waris">Waris</option>
                                        <option value="tukar">Tukar Menukar</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="flex gap-4 justify-end">
                            <button type="button" onclick="resetForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition flex items-center gap-2">
                                <i class="fas fa-redo"></i>
                                Reset
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition flex items-center gap-2">
                                <i class="fas fa-save"></i>
                                Simpan Data
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Data Wajib Pajak Page -->
                <div id="page-data-wp" class="hidden p-6">
                    <div class="mb-6 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Data Wajib Pajak</h2>
                            <p class="text-gray-500">Daftar lengkap wajib pajak daerah</p>
                        </div>
                        <div class="flex flex-col md:flex-row gap-2">
                            <input type="text" id="searchWp" placeholder="Cari wajib pajak..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onkeyup="renderWPTable()">
                            <select id="filterPajak" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="renderWPTable()">
                                <option value="">Semua Pajak</option>
                                <option value="reklame">Pajak Reklame</option>
                                <option value="airtanah">Pajak Air Tanah</option>
                                <option value="walet">Pajak Walet</option>
                                <option value="mineral">Mineral</option>
                                <option value="pbbp2">PBB-P2</option>
                                <option value="bphtb">BPHTB</option>
                                <option value="pbjt_makanan">PBJT M&M</option>
                                <option value="pbjt_listrik">PBJT Listrik</option>
                                <option value="pbjt_perhotelan">PBJT Hotel</option>
                                <option value="pbjt_parkir">PBJT Parkir</option>
                                <option value="pbjt_hiburan">PBJT Hiburan</option>
                                <option value="opsen_pkb">Opsen PKB</option>
                                <option value="opsen_bbnkb">Opsen BBNKB</option>
                            </select>
                            <button onclick="exportWPData()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                <i class="fas fa-file-excel"></i>
                                Export
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">NIK/NPWPD</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Nama WP</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Alamat</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Jenis Pajak</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Status</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="wpTableBody">
                                    <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Belum ada data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Peta Blok Page -->
                <div id="page-peta-blok" class="hidden p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Peta Blok</h2>
                        <p class="text-gray-500">Visualisasi data spasial wajib pajak daerah</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div class="lg:col-span-3 bg-white rounded-xl shadow-md p-4">
                            <div class="mb-3 flex items-center gap-2">
                                <button type="button" id="btnBlockStreet" onclick="switchBlockMapView('street')" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium flex items-center gap-2">
                                    <i class="fas fa-road"></i>
                                    <span>Peta Jalan</span>
                                </button>
                                <button type="button" id="btnBlockSatellite" onclick="switchBlockMapView('satellite')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium flex items-center gap-2">
                                    <i class="fas fa-satellite-dish"></i>
                                    <span>Satelit</span>
                                </button>
                            </div>
                            <div id="blockMap" class="w-full h-[500px] rounded-lg border border-gray-200"></div>
                        </div>
                        <div class="space-y-4">
                            <div class="bg-white rounded-xl shadow-md p-4">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-upload mr-2 text-blue-600"></i>
                                    Import Data Peta
                                </h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1">Format SHP (Zip)</label>
                                        <input type="file" id="shpFile" accept=".zip" class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2">
                                    </div>
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1">Format KMZ/KML</label>
                                        <input type="file" id="kmzFile" accept=".kmz,.kml" class="w-full text-sm border border-gray-300 rounded-lg px-3 py-2">
                                    </div>
                                    <button onclick="importShapeFile()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-sm flex items-center justify-center gap-2">
                                        <i class="fas fa-upload"></i>
                                        Import
                                    </button>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl shadow-md p-4">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-layer-group mr-2 text-green-600"></i>
                                    Legenda
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #3b82f6;"></div>
                                        <span>Pajak Reklame</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #06b6d4;"></div>
                                        <span>Pajak Air Tanah</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #8b5cf6;"></div>
                                        <span>Pajak Walet</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #f59e0b;"></div>
                                        <span>Mineral</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #eab308;"></div>
                                        <span>PBB-P2</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #22c55e;"></div>
                                        <span>BPHTB</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #ec4899;"></div>
                                        <span>PBJT M&M</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #f97316;"></div>
                                        <span>PBJT Listrik</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #14b8a6;"></div>
                                        <span>PBJT Hotel</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #6366f1;"></div>
                                        <span>PBJT Parkir</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #a855f7;"></div>
                                        <span>PBJT Hiburan</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #ef4444;"></div>
                                        <span>Opsen PKB</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded-full" style="background-color: #dc2626;"></div>
                                        <span>Opsen BBNKB</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-xl shadow-md p-4">
                                <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-chart-bar mr-2 text-purple-600"></i>
                                    Statistik Peta
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>Total Titik WP</span>
                                        <span id="totalTitik" class="font-semibold">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Luas Area (Ha)</span>
                                        <span id="totalLuas" class="font-semibold">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kelola User Page -->
                <div id="page-users" class="hidden p-6">
                    <div class="mb-6 flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Kelola User</h2>
                            <p class="text-gray-500">Manajemen pengguna sistem</p>
                        </div>
                        <button onclick="showAddUserModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                            <i class="fas fa-plus"></i>
                            Tambah User
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="userList">
                        <p class="text-gray-500 col-span-full text-center py-8">Belum ada data user</p>
                    </div>
                </div>

                <!-- Laporan Page -->
                <div id="page-laporan" class="hidden p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Laporan</h2>
                        <p class="text-gray-500">Laporan database wajib pajak daerah</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white rounded-xl shadow-md p-6 cursor-pointer hover:shadow-lg transition" onclick="generateReport('rekap')">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-file-alt text-blue-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold">Rekap Wajib Pajak</h3>
                                    <p class="text-sm text-gray-500">Semua data wajib pajak</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-6 cursor-pointer hover:shadow-lg transition" onclick="generateReport('pajak')">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-money-bill text-green-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold">Laporan per Jenis Pajak</h3>
                                    <p class="text-sm text-gray-500">Rincian berdasarkan jenis pajak</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-6 cursor-pointer hover:shadow-lg transition" onclick="generateReport('pendapatan')">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-chart-line text-yellow-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold">Pendapatan Pajak</h3>
                                    <p class="text-sm text-gray-500">Estimasi pendapatan daerah</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-6 cursor-pointer hover:shadow-lg transition" onclick="generateReport('wp_baru')">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-plus text-purple-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold">WP Baru</h3>
                                    <p class="text-sm text-gray-500">Wajib pajak terbaru</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Realisasi Pajak Page -->
                <div id="page-realisasi" class="hidden p-6">
                    <div class="mb-6 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Realisasi Pajak Daerah</h2>
                            <p class="text-gray-500">Monitoring pencapaian target penerimaan pajak daerah</p>
                        </div>
                        <div class="flex flex-col md:flex-row gap-2">
                            <select id="realisasiTahun" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="updateRealisasi()">
                                <!-- Generated by JS -->
                            </select>
                            <button onclick="showInputRealisasiModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                <i class="fas fa-plus"></i>
                                Input Realisasi
                            </button>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-md p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-blue-100 text-sm">Target Pendapatan</p>
                                    <p class="text-2xl font-bold" id="totalTarget">Rp 0</p>
                                </div>
                                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-bullseye text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-md p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-green-100 text-sm">Realisasi</p>
                                    <p class="text-2xl font-bold" id="totalRealisasi">Rp 0</p>
                                </div>
                                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check-circle text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-md p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-purple-100 text-sm">Persentase</p>
                                    <p class="text-2xl font-bold" id="totalPersen">0%</p>
                                </div>
                                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-percentage text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-md p-6 text-white">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-yellow-100 text-sm">Selisih</p>
                                    <p class="text-2xl font-bold" id="totalSelisih">Rp 0</p>
                                </div>
                                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-exchange-alt text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Target vs Realisasi per Jenis Pajak</h3>
                            <canvas id="realisasiChart" height="250"></canvas>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Persentase Capaian per Jenis Pajak</h3>
                            <canvas id="persenChart" height="250"></canvas>
                        </div>
                    </div>

                    <!-- Realisasi Table -->
                    <div class="bg-white rounded-xl shadow-md overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-800">Rincian Realisasi Pajak Daerah</h3>
                            <button onclick="exportRealisasiCSV()" class="text-green-600 hover:text-green-800 flex items-center gap-1">
                                <i class="fas fa-file-excel"></i>
                                Export CSV
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">No</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Jenis Pajak</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold">Target (Rp)</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold">Realisasi (Rp)</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">% Capaian</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold">Selisih (Rp)</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">Status</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="realisasiTableBody">
                                    <tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Belum ada data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Database Online Page -->
                <div id="page-database-online" class="hidden p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Database Online - Firebase</h2>
                        <p class="text-gray-500">Sinkronisasi data dengan database cloud</p>
                    </div>

                    <!-- Connection Status -->
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <i class="fas fa-wifi text-blue-600"></i>
                                Status Koneksi
                            </h3>
                            <span id="onlineStatus" class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600">
                                <i class="fas fa-circle mr-1 text-gray-400"></i>
                                Offline
                            </span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-sm text-blue-600">Status</p>
                                <p class="text-xl font-bold text-blue-800" id="dbStatus">Tidak Tersambung</p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4">
                                <p class="text-sm text-green-600">Data Online</p>
                                <p class="text-xl font-bold text-green-800" id="dbOnlineData">0 record</p>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <p class="text-sm text-purple-600">Data Lokal</p>
                                <p class="text-xl font-bold text-purple-800" id="dbLocalData">0 record</p>
                            </div>
                            <div class="bg-yellow-50 rounded-lg p-4">
                                <p class="text-sm text-yellow-600">Terakhir Sync</p>
                                <p class="text-xl font-bold text-yellow-800" id="dbLastSync">-</p>
                            </div>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <button onclick="syncAllData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                <i class="fas fa-sync"></i>
                                Sync Sekarang
                            </button>
                            <button onclick="showFirebaseConfigModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                                <i class="fas fa-cog"></i>
                                Konfigurasi Firebase
                            </button>
                        </div>
                    </div>

                    <!-- Sync Settings -->
                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-sliders-h text-gray-600"></i>
                            Pengaturan Auto-Sync
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="autoSyncEnabled" class="w-4 h-4 text-blue-600 rounded" onchange="toggleAutoSync()">
                                <span class="text-sm">Aktifkan auto-sync saat online</span>
                            </label>
                            <div class="flex items-center gap-2">
                                <span class="text-sm">Backup otomatis setiap:</span>
                                <select id="backupInterval" class="px-3 py-2 border border-gray-300 rounded-lg text-sm" onchange="updateBackupInterval()">
                                    <option value="15">15 menit</option>
                                    <option value="30" selected>30 menit</option>
                                    <option value="60">1 jam</option>
                                    <option value="120">2 jam</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Backup & Restore -->
                    <div class="bg-white rounded-xl shadow-md p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-hdd text-gray-600"></i>
                            Backup & Restore
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-700 mb-2">Buat Backup</h4>
                                <p class="text-sm text-gray-500 mb-3">Simpan semua data ke file JSON atau cloud</p>
                                <div class="flex gap-2">
                                    <button onclick="createLocalBackup()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-sm flex items-center gap-1">
                                        <i class="fas fa-download"></i>
                                        Download JSON
                                    </button>
                                    <button onclick="createCloudBackup()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-sm flex items-center gap-1">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        Upload ke Cloud
                                    </button>
                                </div>
                            </div>
                            <div class="border border-gray-200 rounded-lg p-4">
                                <h4 class="font-medium text-gray-700 mb-2">Pulihkan Data</h4>
                                <p class="text-sm text-gray-500 mb-3">Pilih file backup untuk dipulihkan</p>
                                <div class="flex gap-2">
                                    <input type="file" id="backupFile" accept=".json" class="text-sm">
                                    <button onclick="restoreFromBackupFile()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded-lg text-sm flex items-center gap-1">
                                        <i class="fas fa-upload"></i>
                                        Pulihkan
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Tambah User Baru</h3>
            <form id="addUserForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" name="username" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" name="password" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" name="namaLengkap" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select name="role" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg">
                        <option value="admin">Admin</option>
                        <option value="petugas">Petugas Pajak</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                <div class="flex gap-3 justify-end mt-4">
                    <button type="button" onclick="closeAddUserModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Batal
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Input Realisasi Modal -->
    <div id="inputRealisasiModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-plus-circle text-blue-600"></i>
                Input Realisasi Pajak Daerah
            </h3>
            <form id="realisasiForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Pajak *</label>
                        <select name="jenisPajakRealisasi" id="jenisPajakRealisasi" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" required>
                            <option value="">Pilih Jenis Pajak</option>
                            <option value="reklame">Pajak Reklame</option>
                            <option value="airtanah">Pajak Air Tanah</option>
                            <option value="walet">Pajak Sarang Burung Walet</option>
                            <option value="mineral">Pajak Mineral Bukan Logam & Batuan</option>
                            <option value="pbbp2">Pajak Bumi dan Bangunan (PBB-P2)</option>
                            <option value="bphtb">BPHTB</option>
                            <option value="pbjt_makanan">PBJT Makanan & Minuman</option>
                            <option value="pbjt_listrik">PBJT Tenaga Listrik</option>
                            <option value="pbjt_perhotelan">PBJT Perhotelan</option>
                            <option value="pbjt_parkir">PBJT Parkir</option>
                            <option value="pbjt_hiburan">PBJT Kesenian & Hiburan</option>
                            <option value="opsen_pkb">Opsen PKB</option>
                            <option value="opsen_bbnkb">Opsen BBNKB</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Periode (Bulan) *</label>
                        <select name="periodeRealisasi" id="periodeRealisasi" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" required>
                            <option value="">Pilih Bulan</option>
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Maret</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Juni</option>
                            <option value="7">Juli</option>
                            <option value="8">Agustus</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Target (Rp) *</label>
                        <input type="number" name="targetRealisasi" id="targetRealisasi" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0" required>
                    </div>
                    <div class="input-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Realisasi (Rp) *</label>
                        <input type="number" name="realisasiValue" id="realisasiValue" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="0" required>
                    </div>
                </div>
                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-calendar-alt mr-1 text-blue-500"></i>
                        Tanggal Realisasi *
                    </label>
                    <input type="date" name="tanggalRealisasi" id="tanggalRealisasi" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" required>
                </div>
                <div class="input-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Catatan (Opsional)</label>
                    <textarea name="catatanRealisasi" id="catatanRealisasi" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" rows="2" placeholder="Catatan tambahan..."></textarea>
                </div>
                <div class="flex gap-3 justify-end mt-4">
                    <button type="button" onclick="closeInputRealisasiModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Batal
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Metode Pembayaran Section -->
<div class="mb-6">
    <label class="block text-sm font-medium text-gray-700 mb-3">
        <i class="fas fa-credit-card mr-2 text-blue-600"></i>
        Metode Pembayaran *
    </label>
    
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <!-- Tunai -->
        <label class="relative cursor-pointer group">
            <input type="radio" name="metodePembayaran" value="tunai" class="peer sr-only" checked>
            <div class="p-4 border-2 border-gray-200 rounded-xl text-center transition-all peer-checked:border-green-500 peer-checked:bg-green-50 hover:border-gray-300">
                <div class="w-12 h-12 mx-auto mb-2 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                </div>
                <p class="font-medium text-gray-700">Tunai</p>
                <p class="text-xs text-gray-500">Uang Tunai</p>
            </div>
        </label>
        
        <!-- Transfer Bank -->
        <label class="relative cursor-pointer group">
            <input type="radio" name="metodePembayaran" value="transfer" class="peer sr-only">
            <div class="p-4 border-2 border-gray-200 rounded-xl text-center transition-all peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-300">
                <div class="w-12 h-12 mx-auto mb-2 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-university text-blue-600 text-xl"></i>
                </div>
                <p class="font-medium text-gray-700">Transfer</p>
                <p class="text-xs text-gray-500">Transfer Bank</p>
            </div>
        </label>
        
        <!-- QRIS -->
        <label class="relative cursor-pointer group">
            <input type="radio" name="metodePembayaran" value="qris" class="peer sr-only">
            <div class="p-4 border-2 border-gray-200 rounded-xl text-center transition-all peer-checked:border-purple-500 peer-checked:bg-purple-50 hover:border-gray-300">
                <div class="w-12 h-12 mx-auto mb-2 bg-purple-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-qrcode text-purple-600 text-xl"></i>
                </div>
                <p class="font-medium text-gray-700">QRIS</p>
                <p class="text-xs text-gray-500">Scan QR Code</p>
            </div>
        </label>
        
        <!-- Merchant -->
        <label class="relative cursor-pointer group">
            <input type="radio" name="metodePembayaran" value="merchant" class="peer sr-only">
            <div class="p-4 border-2 border-gray-200 rounded-xl text-center transition-all peer-checked:border-orange-500 peer-checked:bg-orange-50 hover:border-gray-300">
                <div class="w-12 h-12 mx-auto mb-2 bg-orange-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-credit-card text-orange-600 text-xl"></i>
                </div>
                <p class="font-medium text-gray-700">Merchant</p>
                <p class="text-xs text-gray-500">Kartu/EDC</p>
            </div>
        </label>
    </div>
</div>

<!-- No. Referensi -->
<div class="mb-6">
    <label class="block text-sm font-medium text-gray-700 mb-2">
        <i class="fas fa-receipt mr-2 text-gray-500"></i>
        No. Referensi / Bukti Pembayaran
    </label>
    <input type="text" 
           name="noReferensi" 
           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
           placeholder="Contoh: BKT-2025-0001 atau QR123456789">
    <p class="text-xs text-gray-500 mt-1">
        Masukkan nomor bukti pembayaran (kwitansi, slip transfer, kode QRIS, dll.)
    </p>
</div>

    <!-- Firebase Config Modal -->
    <div id="firebaseConfigModal" class="hidden fixed inset-0 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-fire text-orange-500"></i>
                Konfigurasi Firebase
            </h3>
            <form id="firebaseConfigForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                    <input type="text" name="projectName" id="projectName" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="nama-project">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                    <input type="text" name="apiKey" id="apiKey" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="AIza...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Auth Domain</label>
                    <input type="text" name="authDomain" id="authDomain" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="project.firebaseapp.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Database URL</label>
                    <input type="text" name="databaseURL" id="databaseURL" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg" placeholder="https://project.firebaseio.com">
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-sm text-yellow-700">
                        <i class="fas fa-info-circle mr-1"></i>
                        <strong>Catatan:</strong> Pastikan Firebase Authentication dan Firestore Database sudah diaktifkan di Firebase Console.
                    </p>
                </div>
                <div class="flex gap-3 justify-end mt-4">
                    <button type="button" onclick="closeFirebaseConfigModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">
                        Batal
                    </button>
                    <button type="button" onclick="testFirebaseConnection()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-vial"></i>
                        Test Koneksi
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // =====================================================
        // APPLICATION DATA
        // =====================================================
        let wajibPajak = [];
        let users = [];
        let currentUser = null;
        let wpMap = null;
        let wpMapMarker = null;
        let wpMapCircle = null;
        let blockMap = null;
        let currentMapType = 'street';
        let blockCurrentMapType = 'street';
        let streetLayer = null;
        let satelliteLayer = null;
        let blockStreetLayer = null;
        let blockSatelliteLayer = null;
        let realisasiPajak = [];
        let taxChart = null;
        let realisasiChart = null;
        let persenChart = null;
        let autoSyncEnabled = false;
        let syncInterval = null;
        let isOnline = navigator.onLine;

        // Tax types configuration
        const taxTypes = [
            { code: 'reklame', name: 'Pajak Reklame' },
            { code: 'airtanah', name: 'Pajak Air Tanah' },
            { code: 'walet', name: 'Pajak Walet' },
            { code: 'mineral', name: 'Mineral' },
            { code: 'pbbp2', name: 'PBB-P2' },
            { code: 'bphtb', name: 'BPHTB' },
            { code: 'pbjt_makanan', name: 'PBJT M&M' },
            { code: 'pbjt_listrik', name: 'PBJT Listrik' },
            { code: 'pbjt_perhotelan', name: 'PBJT Hotel' },
            { code: 'pbjt_parkir', name: 'PBJT Parkir' },
            { code: 'pbjt_hiburan', name: 'PBJT Hiburan' },
            { code: 'opsen_pkb', name: 'Opsen PKB' },
            { code: 'opsen_bbnkb', name: 'Opsen BBNKB' }
        ];

        // =====================================================
        // INITIALIZATION
        // =====================================================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            loadDataFromStorage();
            setupEventListeners();
            generateYears();
            updateOnlineStatus();
            
            // Listen for online/offline events
            window.addEventListener('online', () => {
                isOnline = true;
                updateOnlineStatus();
                if (autoSyncEnabled) {
                    showNotification('Online', 'Koneksi internet tersedia', 'success');
                }
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateOnlineStatus();
                showNotification('Offline', 'Koneksi internet terputus', 'warning');
            });
            
            // Check for existing session
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        }

        function loadDataFromStorage() {
            wajibPajak = JSON.parse(localStorage.getItem('wajibPajak')) || [];
            users = JSON.parse(localStorage.getItem('users')) || [
                { id: 1, username: 'admin', password: 'admin123', nama: 'Administrator', role: 'admin' },
                { id: 2, username: 'petugas', password: 'petugas123', nama: 'Petugas Pajak', role: 'petugas' },
                { id: 3, username: 'viewer', password: 'viewer123', nama: 'Viewer', role: 'viewer' }
            ];
            realisasiPajak = JSON.parse(localStorage.getItem('realisasiPajak')) || [];
            autoSyncEnabled = localStorage.getItem('autoSyncEnabled') === 'true';
            
            document.getElementById('autoSyncEnabled').checked = autoSyncEnabled;
        }

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('wpForm').addEventListener('submit', handleWPSubmit);
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('realisasiForm').addEventListener('submit', handleRealisasiSubmit);
            document.getElementById('firebaseConfigForm').addEventListener('submit', saveFirebaseConfig);
        }

        function saveData() {
            localStorage.setItem('wajibPajak', JSON.stringify(wajibPajak));
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('realisasiPajak', JSON.stringify(realisasiPajak));
        }

        // =====================================================
        // AUTHENTICATION
        // =====================================================
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = users.find(u => u.username === username && u.password === password);
            if (user) {
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                showMainApp();
                showNotification('Berhasil', 'Login berhasil!', 'success');
            } else {
                showNotification('Gagal', 'Username atau password salah!', 'error');
            }
        }

        function logout() {
            Swal.fire({
                title: 'Konfirmasi',
                text: 'Apakah Anda yakin ingin logout?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya, Logout',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    currentUser = null;
                    sessionStorage.removeItem('currentUser');
                    document.getElementById('mainApp').classList.add('hidden');
                    document.getElementById('loginPage').classList.remove('hidden');
                }
            });
        }

        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('currentUserName').textContent = currentUser.nama;
            document.getElementById('currentUserRole').textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            showPage('dashboard');
        }

        // =====================================================
        // PAGE NAVIGATION
        // =====================================================
        function showPage(page) {
            document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));

            const selectedPage = document.getElementById(`page-${page}`);
            if (selectedPage) {
                selectedPage.classList.remove('hidden');
            }

            const navLink = document.getElementById(`nav-${page}`);
            if (navLink) {
                navLink.classList.add('active');
            }

            if (page === 'data-wp') {
                renderWPTable();
            } else if (page === 'users') {
                renderUserList();
            } else if (page === 'dashboard') {
                updateDashboard();
            } else if (page === 'realisasi') {
                updateRealisasi();
            } else if (page === 'peta-blok') {
                setTimeout(() => {
                    initializeBlockMap();
                }, 300);
            } else if (page === 'input-wp') {
                setTimeout(() => {
                    initializeWPMaps();
                }, 500);
            } else if (page === 'database-online') {
                updateDatabaseOnlinePage();
            }
        }

        // =====================================================
        // TAX FIELDS TOGGLE
        // =====================================================
        function showTaxFields(taxType) {
            const fieldId = `fields-${taxType}`;
            const isChecked = document.querySelector(`input[value="${taxType}"]`).checked;
            const field = document.getElementById(fieldId);
            
            if (field) {
                if (isChecked) {
                    field.classList.remove('hidden');
                } else {
                    field.classList.add('hidden');
                }
            }
        }

        // =====================================================
        // WP MAP FUNCTIONS - COMPLETE IMPLEMENTATION
        // =====================================================
        function initializeWPMaps() {
            console.log('Initializing WP Map...');
            
            const mapContainer = document.getElementById('wpMap');
            const loadingOverlay = document.getElementById('mapLoading');
            const errorOverlay = document.getElementById('mapError');
            
            if (!mapContainer) {
                console.error('Map container not found');
                return;
            }
            
            // Check if already initialized
            if (wpMap) {
                console.log('Map already initialized, invalidating size...');
                setTimeout(() => {
                    if (wpMap) wpMap.invalidateSize();
                }, 100);
                return;
            }
            
            // Show loading
            if (loadingOverlay) loadingOverlay.style.display = 'flex';
            if (errorOverlay) errorOverlay.classList.add('hidden');
            
            try {
                setTimeout(() => {
                    try {
                        const rect = mapContainer.getBoundingClientRect();
                        console.log('Map container rect:', rect);
                        
                        if (rect.width === 0 || rect.height === 0) {
                            console.warn('Map container has no dimensions, retrying...');
                            if (loadingOverlay) loadingOverlay.style.display = 'none';
                            if (errorOverlay) errorOverlay.classList.remove('hidden');
                            return;
                        }
                        
                        // Initialize map centered on SIDRAP
                        wpMap = L.map('wpMap', {
                            zoomControl: true,
                            attributionControl: true
                        }).setView([-3.9848, 120.2008], 13);
                        
                        wpMap.zoomControl.setPosition('topright');
                        
                        // Add tile layers
                        streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: ' OpenStreetMap contributors',
                            maxZoom: 19
                        });
                        
                        satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                            attribution: ' Esri',
                            maxZoom: 19
                        });
                        
                        streetLayer.addTo(wpMap);
                        currentMapType = 'street';
                        
                        // Add click event handler
                        wpMap.on('click', onMapClick);
                        
                        wpMap.whenReady(() => {
                            console.log('Map is ready');
                            if (loadingOverlay) loadingOverlay.style.display = 'none';
                            updateMapButtonStyles();
                        });
                        
                        wpMap.on('resize', () => {
                            wpMap.invalidateSize();
                        });
                        
                        console.log('Map initialization complete');
                        
                    } catch (innerError) {
                        console.error('Inner error:', innerError);
                        if (loadingOverlay) loadingOverlay.style.display = 'none';
                        if (errorOverlay) errorOverlay.classList.remove('hidden');
                    }
                }, 500);
                
            } catch (error) {
                console.error('Error initializing map:', error);
                if (loadingOverlay) loadingOverlay.style.display = 'none';
                if (errorOverlay) errorOverlay.classList.remove('hidden');
            }
        }

        function onMapClick(e) {
            console.log('Map clicked at:', e.latlng);
            
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Update input fields
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
            
            // Generate address description
            const addressDesc = generateAddressDescription(lat, lng);
            document.getElementById('addressFromCoord').value = addressDesc;
            
            // Add/update marker
            addMarkerToMap(lat, lng);
            
            // Show location status
            showLocationStatus(lat, lng);
            
            showNotification('Berhasil', 'Lokasi berhasil ditentukan!', 'success');
        }

        function addMarkerToMap(lat, lng) {
            if (!wpMap) {
                console.error('Map not initialized');
                return;
            }
            
            // Remove existing marker
            if (wpMapMarker) wpMap.removeLayer(wpMapMarker);
            if (wpMapCircle) wpMap.removeLayer(wpMapCircle);
            
            // Create custom icon
            const customIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="position:relative;width:40px;height:40px;"><div style="width:40px;height:40px;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);border-radius:50% 50% 50% 0;transform:rotate(-45deg);box-shadow:0 4px 12px rgba(239,68,68,0.4);display:flex;align-items:center;justify-content:center;"><i class="fas fa-map-marker-alt" style="color:white;font-size:18px;transform:rotate(45deg);"></i></div><div style="position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:12px;height:12px;background:white;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.2);"></div></div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 40],
                popupAnchor: [0, -40]
            });
            
            // Add marker
            wpMapMarker = L.marker([lat, lng], { icon: customIcon }).addTo(wpMap);
            
            // Add circle
            wpMapCircle = L.circle([lat, lng], {
                color: '#ef4444',
                fillColor: '#ef4444',
                fillOpacity: 0.2,
                radius: 100
            }).addTo(wpMap);
            
            // Add popup
            wpMapMarker.bindPopup(`<div style="text-align:center;min-width:180px;padding:8px;"><div style="margin-bottom:8px;"><i class="fas fa-map-marker-alt text-red-500" style="font-size:24px;"></i></div><strong style="font-size:14px;color:#1f2937;">Lokasi Wajib Pajak</strong><div style="margin-top:8px;font-size:12px;color:#6b7280;"><div><strong>Lat:</strong> ${lat.toFixed(6)}</div><div><strong>Lng:</strong> ${lng.toFixed(6)}</div></div></div>`).openPopup();
            
            // Center on marker
            wpMap.setView([lat, lng], 16, { animate: true });
        }

        function switchMapView(viewType) {
            console.log('Switching to view:', viewType);
            
            if (!wpMap) {
                initializeWPMaps();
                setTimeout(() => {
                    if (wpMap) performMapSwitch(viewType);
                }, 1000);
                return;
            }
            
            performMapSwitch(viewType);
        }

        function performMapSwitch(viewType) {
            try {
                if (viewType === 'satellite') {
                    if (streetLayer) wpMap.removeLayer(streetLayer);
                    if (satelliteLayer) satelliteLayer.addTo(wpMap);
                    currentMapType = 'satellite';
                } else {
                    if (satelliteLayer) wpMap.removeLayer(satelliteLayer);
                    if (streetLayer) streetLayer.addTo(wpMap);
                    currentMapType = 'street';
                }
                
                updateMapButtonStyles();
                
                setTimeout(() => {
                    if (wpMap) wpMap.invalidateSize();
                }, 100);
                
            } catch (error) {
                console.error('Error switching map view:', error);
            }
        }

        function updateMapButtonStyles() {
            const streetBtn = document.getElementById('btnStreetView');
            const satelliteBtn = document.getElementById('btnSatelliteView');
            
            if (streetBtn && satelliteBtn) {
                if (currentMapType === 'street') {
                    streetBtn.className = 'map-btn px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium flex items-center gap-2 shadow-md';
                    satelliteBtn.className = 'map-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium flex items-center gap-2';
                } else {
                    streetBtn.className = 'map-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium flex items-center gap-2';
                    satelliteBtn.className = 'map-btn px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium flex items-center gap-2 shadow-md';
                }
            }
        }

        function getCurrentLocation() {
            if (!wpMap) {
                initializeWPMaps();
                setTimeout(() => getCurrentLocation(), 1000);
                return;
            }
            
            if (navigator.geolocation) {
                Swal.fire({
                    title: 'Mendapatkan Lokasi',
                    text: 'Mohon tunggu, sedang mendapatkan lokasi GPS...',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        document.getElementById('latitude').value = lat.toFixed(6);
                        document.getElementById('longitude').value = lng.toFixed(6);
                        document.getElementById('addressFromCoord').value = `Lokasi GPS: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        
                        addMarkerToMap(lat, lng);
                        showLocationStatus(lat, lng);
                        
                        Swal.close();
                        showNotification('Berhasil', 'Lokasi berhasil ditentukan!', 'success');
                    },
                    (error) => {
                        Swal.fire('Gagal', 'Tidak dapat mendapatkan lokasi GPS: ' + error.message, 'error');
                    }
                );
            } else {
                showNotification('Gagal', 'Browser tidak mendukung GPS', 'error');
            }
        }

        function clearMapLocation() {
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            document.getElementById('addressFromCoord').value = '';
            
            if (wpMapMarker) {
                wpMap.removeLayer(wpMapMarker);
                wpMapMarker = null;
            }
            if (wpMapCircle) {
                wpMap.removeLayer(wpMapCircle);
                wpMapCircle = null;
            }
            
            const statusDiv = document.getElementById('locationStatus');
            if (statusDiv) statusDiv.classList.add('hidden');
            
            if (wpMap) {
                wpMap.setView([-3.9848, 120.2008], 13);
            }
            
            showNotification('Berhasil', 'Lokasi telah dihapus', 'success');
        }

        function showLocationStatus(lat, lng) {
            const statusDiv = document.getElementById('locationStatus');
            const statusDetails = document.getElementById('locationStatusDetails');
            
            if (statusDiv && statusDetails) {
                statusDetails.innerHTML = `<strong>Koordinat:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br><strong>Lokasi:</strong> ${generateAddressDescription(lat, lng)}`;
                statusDiv.classList.remove('hidden');
            }
        }

        function generateAddressDescription(lat, lng) {
            const latInSidrap = lat >= -4.05 && lat <= -3.90;
            const lngInSidrap = lng >= 120.10 && lng <= 120.35;
            
            if (latInSidrap && lngInSidrap) {
                return 'Kabupaten Sidenreng Rappang, Sulawesi Selatan';
            }
            
            return `Koordinat: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        // =====================================================
        // BLOCK MAP FUNCTIONS
        // =====================================================
        function initializeBlockMap() {
            if (blockMap) {
                blockMap.invalidateSize();
                return;
            }
            
            try {
                blockMap = L.map('blockMap').setView([-3.9848, 120.2008], 13);
                
                blockStreetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: ' OpenStreetMap contributors'
                });
                
                blockSatelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: ' Esri'
                });
                
                blockStreetLayer.addTo(blockMap);
                blockCurrentMapType = 'street';
                
                // Add WP markers
                wajibPajak.forEach(wp => {
                    if (wp.latitude && wp.longitude) {
                        const color = getTaxColor(wp.jenisPajak);
                        const marker = L.circleMarker([wp.latitude, wp.longitude], {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.7,
                            radius: 8
                        }).addTo(blockMap);
                        
                        marker.bindPopup(`<strong>${wp.nama}</strong><br>${wp.alamat}<br>Jenis: ${Array.isArray(wp.jenisPajak) ? wp.jenisPajak.join(', ') : wp.jenisPajak}`);
                    }
                });
                
                document.getElementById('totalTitik').textContent = wajibPajak.filter(wp => wp.latitude && wp.longitude).length;
                
                updateBlockMapButtonStyles();
                
            } catch (error) {
                console.error('Error initializing block map:', error);
            }
        }

        function switchBlockMapView(viewType) {
            if (!blockMap) {
                initializeBlockMap();
                return;
            }
            
            try {
                if (viewType === 'satellite') {
                    if (blockStreetLayer) blockMap.removeLayer(blockStreetLayer);
                    if (blockSatelliteLayer) blockSatelliteLayer.addTo(blockMap);
                    blockCurrentMapType = 'satellite';
                } else {
                    if (blockSatelliteLayer) blockMap.removeLayer(blockSatelliteLayer);
                    if (blockStreetLayer) blockStreetLayer.addTo(blockMap);
                    blockCurrentMapType = 'street';
                }
                
                updateBlockMapButtonStyles();
                
                setTimeout(() => {
                    if (blockMap) blockMap.invalidateSize();
                }, 100);
                
            } catch (error) {
                console.error('Error switching block map view:', error);
            }
        }

        function updateBlockMapButtonStyles() {
            const streetBtn = document.getElementById('btnBlockStreet');
            const satelliteBtn = document.getElementById('btnBlockSatellite');
            
            if (streetBtn && satelliteBtn) {
                if (blockCurrentMapType === 'street') {
                    streetBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium flex items-center gap-2';
                    satelliteBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium flex items-center gap-2';
                } else {
                    streetBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium flex items-center gap-2';
                    satelliteBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium flex items-center gap-2';
                }
            }
        }

        function getTaxColor(taxTypes) {
            const colors = {
                reklame: '#3b82f6',
                airtanah: '#06b6d4',
                walet: '#8b5cf6',
                mineral: '#f59e0b',
                pbbp2: '#eab308',
                bphtb: '#22c55e',
                pbjt_makanan: '#ec4899',
                pbjt_listrik: '#f97316',
                pbjt_perhotelan: '#14b8a6',
                pbjt_parkir: '#6366f1',
                pbjt_hiburan: '#a855f7',
                opsen_pkb: '#ef4444',
                opsen_bbnkb: '#dc2626'
            };
            
            if (Array.isArray(taxTypes)) {
                return colors[taxTypes[0]] || '#6b7280';
            }
            return colors[taxTypes] || '#6b7280';
        }

        // =====================================================
        // IMPORT SHAPEFILE
        // =====================================================
        function importShapeFile() {
            const shpFile = document.getElementById('shpFile').files[0];
            const kmzFile = document.getElementById('kmzFile').files[0];
            
            if (!shpFile && !kmzFile) {
                showNotification('Peringatan', 'Pilih file terlebih dahulu!', 'warning');
                return;
            }
            
            Swal.fire({
                title: 'Memproses',
                text: 'Sedang memproses file...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
            
            if (shpFile) {
                processShapefile(shpFile);
            } else if (kmzFile) {
                processKMZFile(kmzFile);
            }
        }

        function processShapefile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    
                    shp(arrayBuffer).then(function(geojson) {
                        displayGeojsonOnMap(geojson, 'Shapefile');
                    }).catch(function(err) {
                        console.error('Error parsing shapefile:', err);
                        Swal.fire('Gagal', 'Gagal memproses file: ' + err.message, 'error');
                    });
                } catch (err) {
                    console.error('Error reading file:', err);
                    Swal.fire('Gagal', 'Gagal membaca file: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processKMZFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    
                    JSZip.loadAsync(arrayBuffer).then(function(zip) {
                        const kmlFile = Object.keys(zip.files).find(name => name.endsWith('.kml'));
                        if (kmlFile) {
                            return zip.file(kmlFile).async('string');
                        } else {
                            throw new Error('File KML tidak ditemukan dalam KMZ');
                        }
                    }).then(function(kmlContent) {
                        parseKMLAndDisplay(kmlContent, 'KMZ');
                    }).catch(function(err) {
                        console.error('Error processing KMZ:', err);
                        Swal.fire('Gagal', 'Gagal memproses file KMZ: ' + err.message, 'error');
                    });
                } catch (err) {
                    console.error('Error reading KMZ file:', err);
                    Swal.fire('Gagal', 'Gagal memproses file: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function parseKMLAndDisplay(kmlContent, fileType) {
            try {
                const parser = new DOMParser();
                const kmlDoc = parser.parseFromString(kmlContent, 'text/xml');
                
                const geojson = { type: 'FeatureCollection', features: [] };
                const placemarks = kmlDoc.getElementsByTagName('Placemark');
                
                for (let i = 0; i < placemarks.length; i++) {
                    const placemark = placemarks[i];
                    const name = placemark.getElementsByTagName('name')[0]?.textContent || '';
                    const coords = placemark.getElementsByTagName('coordinates')[0]?.textContent.trim().split(',');
                    
                    if (coords && coords.length >= 2) {
                        geojson.features.push({
                            type: 'Feature',
                            properties: { name },
                            geometry: { type: 'Point', coordinates: [parseFloat(coords[0]), parseFloat(coords[1])] }
                        });
                    }
                }
                
                displayGeojsonOnMap(geojson, fileType);
            } catch (err) {
                console.error('Error parsing KML:', err);
                Swal.fire('Gagal', 'Gagal memparsing file KML: ' + err.message, 'error');
            }
        }

        function displayGeojsonOnMap(geojson, fileType) {
            if (!blockMap) {
                initializeBlockMap();
            }
            
            const geojsonLayer = L.geoJSON(geojson, {
                pointToLayer: function(feature, latlng) {
                    return L.circleMarker(latlng, {
                        color: '#22c55e',
                        fillColor: '#22c55e',
                        fillOpacity: 0.7,
                        radius: 8
                    });
                },
                onEachFeature: function(feature, layer) {
                    if (feature.properties && feature.properties.name) {
                        layer.bindPopup(`<strong>${feature.properties.name}</strong>`);
                    }
                }
            });
            
            geojsonLayer.addTo(blockMap);
            blockMap.fitBounds(geojsonLayer.getBounds(), { padding: [50, 50] });
            
            Swal.fire('Berhasil', `Data ${fileType} berhasil diimport! ${geojson.features.length} fitur ditemukan.`, 'success');
            
            document.getElementById('shpFile').value = '';
            document.getElementById('kmzFile').value = '';
        }

        // =====================================================
        // WP FORM SUBMIT
        // =====================================================
        function handleWPSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const selectedPajak = Array.from(document.querySelectorAll('input[name="jenisPajak"]:checked')).map(cb => cb.value);
            
            if (selectedPajak.length === 0) {
                showNotification('Peringatan', 'Pilih minimal satu jenis pajak!', 'warning');
                return;
            }
            
            const wpData = {
                id: Date.now(),
                nik: formData.get('nik'),
                npwp: formData.get('npwp'),
                nama: formData.get('nama'),
                namaUsaha: formData.get('namaUsaha'),
                email: formData.get('email'),
                telepon: formData.get('telepon'),
                jenisKelamin: formData.get('jenisKelamin'),
                status: formData.get('status'),
                statusKeaktifan: formData.get('statusKeaktifan'),
                kepatuhan: formData.get('kepatuhan'),
                alamat: formData.get('alamat'),
                kecamatan: formData.get('kecamatan'),
                kelurahan: formData.get('kelurahan'),
                kodePos: formData.get('kodePos'),
                latitude: formData.get('latitude'),
                longitude: formData.get('longitude'),
                jenisPajak: selectedPajak,
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.nama || 'Admin'
            };
            
            // Collect tax-specific data
            selectedPajak.forEach(pajak => {
                const prefix = pajak.replace('_', '');
                wpData[pajak] = {};
                const inputs = document.querySelectorAll(`[name^="${prefix}_"]`);
                inputs.forEach(input => {
                    wpData[pajak][input.name.replace(`${prefix}_`, '')] = input.value;
                });
            });
            
            wajibPajak.push(wpData);
            saveData();
            
            showNotification('Berhasil', 'Data wajib pajak berhasil disimpan!', 'success');
            e.target.reset();
            document.querySelectorAll('[id^="fields-"]').forEach(f => f.classList.add('hidden'));
            
            // Clear map
            clearMapLocation();
        }

        function resetForm() {
            document.getElementById('wpForm').reset();
            document.querySelectorAll('[id^="fields-"]').forEach(f => f.classList.add('hidden'));
            clearMapLocation();
        }

        // =====================================================
        // DATA TABLE FUNCTIONS
        // =====================================================
        function renderWPTable() {
            const tbody = document.getElementById('wpTableBody');
            const search = document.getElementById('searchWp')?.value.toLowerCase() || '';
            const filter = document.getElementById('filterPajak')?.value || '';
            
            let filtered = wajibPajak.filter(wp => {
                const matchSearch = wp.nama.toLowerCase().includes(search) || 
                                   (wp.nik && wp.nik.includes(search)) || 
                                   (wp.alamat && wp.alamat.toLowerCase().includes(search));
                const matchFilter = !filter || (wp.jenisPajak && wp.jenisPajak.includes(filter));
                return matchSearch && matchFilter;
            });
            
            tbody.innerHTML = filtered.map(wp => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm">${wp.nik || '-'}</td>
                    <td class="px-4 py-3 text-sm font-medium">${wp.nama}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${wp.alamat}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex flex-wrap gap-1">
                            ${(wp.jenisPajak || []).map(p => `<span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">${getTaxName(p)}</span>`).join('')}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 ${wp.statusKeaktifan === 'Aktif' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} text-xs rounded-full">${wp.statusKeaktifan || 'Aktif'}</span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="deleteWp(${wp.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Tidak ada data</td></tr>';
        }

        function getTaxName(code) {
            const tax = taxTypes.find(t => t.code === code);
            return tax ? tax.name : code;
        }

        function deleteWp(id) {
            Swal.fire({
                title: 'Konfirmasi',
                text: 'Apakah Anda yakin ingin menghapus data ini?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ya, Hapus',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    wajibPajak = wajibPajak.filter(w => w.id !== id);
                    saveData();
                    renderWPTable();
                    showNotification('Berhasil', 'Data berhasil dihapus!', 'success');
                }
            });
        }

        function exportWPData() {
            if (wajibPajak.length === 0) {
                showNotification('Peringatan', 'Tidak ada data untuk diexport!', 'warning');
                return;
            }
            
            const csv = Papa.unparse(wajibPajak.map(wp => ({
                NIK: wp.nik,
                NPWPD: wp.npwp,
                Nama: wp.nama,
                Nama_Usaha: wp.namaUsaha,
                Email: wp.email,
                Telepon: wp.telepon,
                Alamat: wp.alamat,
                Kecamatan: wp.kecamatan,
                Kelurahan: wp.kelurahan,
                Status_Keaktifan: wp.statusKeaktifan,
                Kepatuhan: wp.kepatuhan,
                Latitude: wp.latitude,
                Longitude: wp.longitude,
                Jenis_Pajak: (wp.jenisPajak || []).join('; '),
                Tanggal_Daftar: wp.createdAt
            })));
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `database_wp_sidrap_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showNotification('Berhasil', 'Data berhasil diexport!', 'success');
        }

        // =====================================================
        // USER MANAGEMENT
        // =====================================================
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.remove('hidden');
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.add('hidden');
            document.getElementById('addUserForm').reset();
        }

        function handleAddUser(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const newUser = {
                id: Date.now(),
                username: formData.get('username'),
                password: formData.get('password'),
                nama: formData.get('namaLengkap'),
                role: formData.get('role')
            };
            
            if (users.find(u => u.username === newUser.username)) {
                showNotification('Gagal', 'Username sudah digunakan!', 'error');
                return;
            }
            
            users.push(newUser);
            saveData();
            
            closeAddUserModal();
            renderUserList();
            showNotification('Berhasil', 'User berhasil ditambahkan!', 'success');
        }

        function renderUserList() {
            const container = document.getElementById('userList');
            container.innerHTML = users.map(user => `
                <div class="bg-white rounded-xl shadow-md p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-blue-600"></i>
                        </div>
                        <div>
                            <h4 class="font-semibold">${user.nama}</h4>
                            <p class="text-sm text-gray-500">@${user.username}</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="px-2 py-1 text-xs rounded-full ${user.role === 'admin' ? 'bg-red-100 text-red-700' : user.role === 'petugas' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'}">${user.role}</span>
                        ${user.role !== 'admin' ? `
                        <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-800 text-sm flex items-center gap-1">
                            <i class="fas fa-trash"></i>
                            Hapus
                        </button>
                        ` : '<span class="text-gray-400 text-sm">Default</span>'}
                    </div>
                </div>
            `).join('') || '<p class="text-gray-500 col-span-full text-center py-8">Belum ada data user</p>';
        }

        function deleteUser(id) {
            Swal.fire({
                title: 'Konfirmasi',
                text: 'Apakah Anda yakin ingin menghapus user ini?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ya, Hapus',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    users = users.filter(u => u.id !== id);
                    saveData();
                    renderUserList();
                    showNotification('Berhasil', 'User berhasil dihapus!', 'success');
                }
            });
        }

        // =====================================================
        // DASHBOARD
        // =====================================================
        function updateDashboard() {
            document.getElementById('totalWp').textContent = wajibPajak.length;
            document.getElementById('pajakAktif').textContent = wajibPajak.filter(w => w.jenisPajak && w.jenisPajak.length > 0).length;
            document.getElementById('userAktif').textContent = users.length;
            
            // Recent taxes
            const recentContainer = document.getElementById('recentTaxList');
            const recent = wajibPajak.slice(-5).reverse();
            recentContainer.innerHTML = recent.map(wp => `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                    <div>
                        <p class="font-medium text-sm">${wp.nama}</p>
                        <p class="text-xs text-gray-500">${(wp.jenisPajak || []).map(p => getTaxName(p)).join(', ')}</p>
                    </div>
                    <span class="text-xs text-gray-400">${new Date(wp.createdAt).toLocaleDateString()}</span>
                </div>
            `).join('') || '<p class="text-gray-500 text-center py-4">Belum ada data</p>';
            
            // Tax type chart
            updateTaxChart();
            
            // Realisasi summary
            updateRealisasiSummary();
        }

        function updateTaxChart() {
            const ctx = document.getElementById('taxTypeChart');
            if (!ctx) return;
            
            const taxCounts = {};
            wajibPajak.forEach(wp => {
                (wp.jenisPajak || []).forEach(pajak => {
                    taxCounts[pajak] = (taxCounts[pajak] || 0) + 1;
                });
            });
            
            const labels = Object.keys(taxCounts).map(k => getTaxName(k));
            const data = Object.values(taxCounts);
            
            if (taxChart) taxChart.destroy();
            
            taxChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Wajib Pajak',
                        data: data,
                        backgroundColor: ['#3b82f6', '#06b6d4', '#8b5cf6', '#f59e0b', '#eab308', '#22c55e', '#ec4899', '#f97316', '#14b8a6', '#6366f1', '#a855f7', '#ef4444', '#dc2626'],
                        borderWidth: 0,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        function updateRealisasiSummary() {
            const tahun = document.getElementById('realisasiTahun')?.value || new Date().getFullYear();
            const filteredData = realisasiPajak.filter(r => r.tahun == tahun);
            
            const taxData = taxTypes.map(tax => {
                const data = filteredData.filter(d => d.jenisPajak === tax.code);
                const target = data.reduce((sum, d) => sum + d.target, 0);
                const realisasi = data.reduce((sum, d) => sum + d.realisasi, 0);
                return { ...tax, target, realisasi, persen: target > 0 ? ((realisasi / target) * 100).toFixed(1) : 0 };
            });
            
            const totalTarget = taxData.reduce((sum, t) => sum + t.target, 0);
            const totalRealisasi = taxData.reduce((sum, t) => sum + t.realisasi, 0);
            const totalPersen = totalTarget > 0 ? ((totalRealisasi / totalTarget) * 100).toFixed(1) : 0;
            
            document.getElementById('dashTargetYear').textContent = tahun;
            document.getElementById('dashTarget').textContent = 'Rp ' + totalTarget.toLocaleString('id-ID');
            document.getElementById('dashRealisasi').textContent = 'Rp ' + totalRealisasi.toLocaleString('id-ID');
            document.getElementById('dashPersen').textContent = totalPersen + '%';
            document.getElementById('dashSelisih').textContent = 'Rp ' + (totalRealisasi - totalTarget).toLocaleString('id-ID');
            
            const progressBar = document.getElementById('dashProgressBar');
            if (progressBar) {
                progressBar.style.width = Math.min(totalPersen, 100) + '%';
            }
        }

        // =====================================================
        // REALISASI PAJAK
        // =====================================================
        function generateYears() {
            const select = document.getElementById('realisasiTahun');
            if (!select) return;
            
            select.innerHTML = '';
            for (let year = 2020; year <= 2035; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === new Date().getFullYear()) option.selected = true;
                select.appendChild(option);
            }
        }

        function showInputRealisasiModal() {
            document.getElementById('inputRealisasiModal').classList.remove('hidden');
            document.getElementById('periodeRealisasi').value = new Date().getMonth() + 1;
            document.getElementById('tanggalRealisasi').value = new Date().toISOString().split('T')[0];
        }

        function closeInputRealisasiModal() {
            document.getElementById('inputRealisasiModal').classList.add('hidden');
            document.getElementById('realisasiForm').reset();
        }

        function handleRealisasiSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tahun = document.getElementById('realisasiTahun').value;
            
            const newData = {
                id: Date.now(),
                jenisPajak: formData.get('jenisPajakRealisasi'),
                periode: formData.get('periodeRealisasi'),
                tahun: parseInt(tahun),
                tanggalRealisasi: formData.get('tanggalRealisasi'),
                target: parseFloat(formData.get('targetRealisasi')),
                realisasi: parseFloat(formData.get('realisasiValue')),
                catatan: formData.get('catatanRealisasi'),
                createdAt: new Date().toISOString(),
                createdBy: currentUser?.nama || 'Admin'
            };
            
            const existingIndex = realisasiPajak.findIndex(r =>
                r.jenisPajak === newData.jenisPajak &&
                r.periode === newData.periode &&
                r.tahun === newData.tahun
            );
            
            if (existingIndex >= 0) {
                realisasiPajak[existingIndex] = newData;
            } else {
                realisasiPajak.push(newData);
            }
            
            saveData();
            closeInputRealisasiModal();
            updateRealisasi();
            showNotification('Berhasil', 'Data realisasi berhasil disimpan!', 'success');
        }

        function updateRealisasi() {
            const tahun = document.getElementById('realisasiTahun')?.value || new Date().getFullYear();
            const filteredData = realisasiPajak.filter(r => r.tahun == tahun);
            
            let totalTarget = 0;
            let totalRealisasi = 0;
            
            const taxData = taxTypes.map(tax => {
                const data = filteredData.filter(d => d.jenisPajak === tax.code);
                const target = data.reduce((sum, d) => sum + d.target, 0);
                const realisasi = data.reduce((sum, d) => sum + d.realisasi, 0);
                totalTarget += target;
                totalRealisasi += realisasi;
                return { ...tax, target, realisasi, selisih: realisasi - target, persen: target > 0 ? ((realisasi / target) * 100).toFixed(1) : 0 };
            });
            
            document.getElementById('totalTarget').textContent = 'Rp ' + totalTarget.toLocaleString('id-ID');
            document.getElementById('totalRealisasi').textContent = 'Rp ' + totalRealisasi.toLocaleString('id-ID');
            const totalPersen = totalTarget > 0 ? ((totalRealisasi / totalTarget) * 100).toFixed(1) : 0;
            document.getElementById('totalPersen').textContent = totalPersen + '%';
            document.getElementById('totalSelisih').textContent = 'Rp ' + (totalRealisasi - totalTarget).toLocaleString('id-ID');
            
            renderRealisasiTable(taxData);
            updateRealisasiCharts(taxData);
        }

        function renderRealisasiTable(taxData) {
            const tbody = document.getElementById('realisasiTableBody');
            tbody.innerHTML = taxData.map((tax, index) => {
                const persen = parseFloat(tax.persen);
                let status, statusClass;
                if (persen >= 100) { status = 'Melampaui'; statusClass = 'bg-green-100 text-green-700'; }
                else if (persen >= 80) { status = 'On Track'; statusClass = 'bg-blue-100 text-blue-700'; }
                else if (persen >= 50) { status = 'Progress'; statusClass = 'bg-yellow-100 text-yellow-700'; }
                else { status = 'Kurang'; statusClass = 'bg-red-100 text-red-700'; }
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">${index + 1}</td>
                        <td class="px-4 py-3 text-sm">${tax.name}</td>
                        <td class="px-4 py-3 text-sm text-right">${tax.target.toLocaleString('id-ID')}</td>
                        <td class="px-4 py-3 text-sm text-right">${tax.realisasi.toLocaleString('id-ID')}</td>
                        <td class="px-4 py-3 text-sm text-center">
                            <div class="flex items-center justify-center gap-2">
                                <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full ${persen >= 100 ? 'bg-green-500' : persen >= 80 ? 'bg-blue-500' : persen >= 50 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${Math.min(persen, 100)}%"></div>
                                </div>
                                <span class="text-xs">${tax.persen}%</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-right ${tax.selisih >= 0 ? 'text-green-600' : 'text-red-600'}">${tax.selisih.toLocaleString('id-ID')}</td>
                        <td class="px-4 py-3 text-sm text-center">
                            <span class="px-2 py-1 text-xs rounded-full ${statusClass}">${status}</span>
                        </td>
                        <td class="px-4 py-3 text-sm text-center">
                            <button onclick="editRealisasi('${tax.code}')" class="text-blue-600 hover:text-blue-800 mx-1">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('') || '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Belum ada data</td></tr>';
        }

        function editRealisasi(code) {
            showNotification('Info', 'Fitur edit realisasi', 'info');
        }

        function updateRealisasiCharts(taxData) {
            const ctx1 = document.getElementById('realisasiChart');
            if (realisasiChart) realisasiChart.destroy();
            
            if (ctx1) {
                realisasiChart = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: taxData.map(t => t.name),
                        datasets: [
                            { label: 'Target', data: taxData.map(t => t.target), backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: '#3b82f6', borderWidth: 1, borderRadius: 4 },
                            { label: 'Realisasi', data: taxData.map(t => t.realisasi), backgroundColor: 'rgba(34, 197, 94, 0.5)', borderColor: '#22c55e', borderWidth: 1, borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'top' } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
            
            const ctx2 = document.getElementById('persenChart');
            if (persenChart) persenChart.destroy();
            
            if (ctx2) {
                persenChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: taxData.map(t => t.name),
                        datasets: [{ data: taxData.map(t => t.persen), backgroundColor: ['#3b82f6', '#06b6d4', '#8b5cf6', '#f59e0b', '#eab308', '#22c55e', '#ec4899', '#f97316', '#14b8a6', '#6366f1', '#a855f7', '#ef4444', '#dc2626'] }]
                    },
                    options: { responsive: true, plugins: { legend: { position: 'right' } } }
                });
            }
        }

        function exportRealisasiCSV() {
            const tahun = document.getElementById('realisasiTahun')?.value || new Date().getFullYear();
            const filteredData = realisasiPajak.filter(r => r.tahun == tahun);
            
            if (filteredData.length === 0) {
                showNotification('Peringatan', 'Tidak ada data untuk diexport!', 'warning');
                return;
            }
            
            const exportData = filteredData.map(r => ({
                'Jenis Pajak': taxTypes.find(t => t.code === r.jenisPajak)?.name || r.jenisPajak,
                'Periode': ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][r.periode - 1],
                'Tahun': r.tahun,
                'Tanggal': r.tanggalRealisasi,
                'Target (Rp)': r.target,
                'Realisasi (Rp)': r.realisasi,
                'Persentase': r.target > 0 ? ((r.realisasi / r.target) * 100).toFixed(2) + '%' : '0%',
                'Catatan': r.catatan || ''
            }));
            
            const csv = Papa.unparse(exportData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `realisasi_pajak_sidrap_${tahun}.csv`;
            link.click();
            
            showNotification('Berhasil', 'Data berhasil diexport!', 'success');
        }

        // =====================================================
        // REPORTS
        // =====================================================
        function generateReport(type) {
            if (type === 'rekap') {
                exportWPData();
            } else {
                showNotification('Berhasil', `Laporan ${type} berhasil dibuat!`, 'success');
            }
        }

        // =====================================================
        // DATABASE ONLINE - FIREBASE
        // =====================================================
        function updateOnlineStatus() {
            const statusEl = document.getElementById('onlineStatus');
            if (statusEl) {
                statusEl.innerHTML = isOnline 
                    ? '<i class="fas fa-circle mr-1 text-green-500"></i> Online'
                    : '<i class="fas fa-circle mr-1 text-gray-400"></i> Offline';
                statusEl.className = isOnline ? 'px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700' : 'px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600';
            }
            
            const dbStatus = document.getElementById('dbStatus');
            if (dbStatus) {
                dbStatus.textContent = isOnline ? 'Online' : 'Tersimpan Lokal';
            }
            
            const dbOnlineData = document.getElementById('dbOnlineData');
            const dbLocalData = document.getElementById('dbLocalData');
            if (dbOnlineData) dbOnlineData.textContent = `${wajibPajak.length + realisasiPajak.length} record`;
            if (dbLocalData) dbLocalData.textContent = `${wajibPajak.length + realisasiPajak.length} record`;
        }

        function updateDatabaseOnlinePage() {
            updateOnlineStatus();
            
            const lastSync = localStorage.getItem('lastSyncTime');
            const dbLastSync = document.getElementById('dbLastSync');
            if (dbLastSync && lastSync) {
                dbLastSync.textContent = new Date(lastSync).toLocaleString('id-ID');
            }
        }

        function syncAllData() {
            showNotification('Info', 'Data telah tersimpan secara lokal. Fitur cloud sync memerlukan konfigurasi Firebase.', 'info');
        }

        function showFirebaseConfigModal() {
            document.getElementById('firebaseConfigModal').classList.remove('hidden');
        }

        function closeFirebaseConfigModal() {
            document.getElementById('firebaseConfigModal').classList.add('hidden');
        }

        function testFirebaseConnection() {
            Swal.fire({
                title: 'Menguji Koneksi',
                text: 'Mohon tunggu...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });
            
            setTimeout(() => {
                Swal.fire('Info', 'Untuk menggunakan fitur cloud sync, diperlukan konfigurasi Firebase yang valid. Data tersimpan secara lokal di browser.', 'info');
            }, 1500);
        }

        function saveFirebaseConfig(e) {
            e.preventDefault();
            
            const config = {
                projectName: document.getElementById('projectName').value,
                apiKey: document.getElementById('apiKey').value,
                authDomain: document.getElementById('authDomain').value,
                databaseURL: document.getElementById('databaseURL').value
            };
            
            localStorage.setItem('firebaseConfig', JSON.stringify(config));
            
            closeFirebaseConfigModal();
            showNotification('Berhasil', 'Konfigurasi Firebase disimpan!', 'success');
        }

        function toggleAutoSync() {
            autoSyncEnabled = document.getElementById('autoSyncEnabled').checked;
            localStorage.setItem('autoSyncEnabled', autoSyncEnabled);
            
            if (autoSyncEnabled) {
                showNotification('Berhasil', 'Auto-sync diaktifkan', 'success');
            } else {
                showNotification('Info', 'Auto-sync dinonaktifkan', 'info');
            }
        }

        function updateBackupInterval() {
            const interval = document.getElementById('backupInterval').value;
            localStorage.setItem('backupInterval', interval);
            showNotification('Berhasil', 'Interval backup diperbarui', 'success');
        }

        function createLocalBackup() {
            const backupData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                data: { wajibPajak, users, realisasiPajak }
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup_sidrap_pajak_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showNotification('Berhasil', 'Backup berhasil diunduh!', 'success');
        }

        function createCloudBackup() {
            showNotification('Info', 'Fitur cloud backup memerlukan konfigurasi Firebase.', 'info');
        }

        function restoreFromBackupFile() {
            const file = document.getElementById('backupFile').files[0];
            if (!file) {
                showNotification('Peringatan', 'Pilih file backup terlebih dahulu!', 'warning');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    Swal.fire({
                        title: 'Konfirmasi Restore',
                        text: 'Data saat ini akan diganti dengan data dari backup. Lanjutkan?',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Ya, Restore',
                        cancelButtonText: 'Batal'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            wajibPajak = backupData.data.wajibPajak || [];
                            users = backupData.data.users || [];
                            realisasiPajak = backupData.data.realisasiPajak || [];
                            saveData();
                            showNotification('Berhasil', 'Backup berhasil direstore!', 'success');
                        }
                    });
                } catch (error) {
                    showNotification('Gagal', 'File backup tidak valid: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================
        function showNotification(title, text, icon) {
            Swal.fire(title, text, icon);
        }

        // Make functions globally accessible
        window.showPage = showPage;
        window.showTaxFields = showTaxFields;
        window.switchMapView = switchMapView;
        window.switchBlockMapView = switchBlockMapView;
        window.getCurrentLocation = getCurrentLocation;
        window.clearMapLocation = clearMapLocation;
        window.initializeWPMaps = initializeWPMaps;
        window.importShapeFile = importShapeFile;
        window.handleWPSubmit = handleWPSubmit;
        window.resetForm = resetForm;
        window.deleteWp = deleteWp;
        window.showAddUserModal = showAddUserModal;
        window.closeAddUserModal = closeAddUserModal;
        window.deleteUser = deleteUser;
        window.generateReport = generateReport;
        window.showInputRealisasiModal = showInputRealisasiModal;
        window.closeInputRealisasiModal = closeInputRealisasiModal;
        window.exportRealisasiCSV = exportRealisasiCSV;
        window.syncAllData = syncAllData;
        window.showFirebaseConfigModal = showFirebaseConfigModal;
        window.closeFirebaseConfigModal = closeFirebaseConfigModal;
        window.testFirebaseConnection = testFirebaseConnection;
        window.saveFirebaseConfig = saveFirebaseConfig;
        window.toggleAutoSync = toggleAutoSync;
        window.updateBackupInterval = updateBackupInterval;
        window.createLocalBackup = createLocalBackup;
        window.createCloudBackup = createCloudBackup;
        window.restoreFromBackupFile = restoreFromBackupFile;
        window.logout = logout;
    </script>
</body>
</html>
